<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <!-- Ajusta si tu API corre en otra URL/puerto -->
    <meta name="api-base" content="http://localhost:3001">
    <title>NOVATech • Historial de servicios (Admin)</title>
    <link rel="stylesheet" href="styles.css"/>

    <!-- Blindaje: ningún control de admin clásico debe verse en este panel -->
    <style>
      /* Sin UI de edición en esta vista */
      #add-user-btn, #admin-table, .actions, .icon.red, .icon.blue { display: none !important; }

      .hist-toolbar {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: .75rem;
        align-items: end;
        margin: .75rem 0 1.25rem;
      }
      .hist-toolbar .form-row label { display:block; font-weight:600; margin-bottom:.25rem; }
      .stats {
        display:grid; gap:.5rem; grid-template-columns: repeat(3, minmax(0,1fr));
        margin: .5rem 0 1rem;
      }
      .stat {
        border: 1px solid #e5e7eb; border-radius: 12px; padding: .75rem .9rem;
      }
      .stat .k { font-size: 1.15rem; font-weight: 700; }
      .stat .l { color:#6b7280; font-size: .9rem; }
      .table-wrap { overflow:auto; }
      .table th, .table td { white-space: nowrap; }
      .pill { border-radius:999px; padding:.1rem .5rem; border:1px solid #e5e7eb; font-size:.85rem; }
      .meta.error { color:#b91c1c; }
      .meta.ok { color:#065f46; }
    </style>
  </head>
  <body data-page="admin">
    <header>
      <div class="container navbar">
        <a class="brand" href="index.html">
          <span class="logo"></span> <span>NOVATech</span>
        </a>
        <nav class="navlinks" id="site-nav">
          <a href="index.html" data-nav="index">Inicio</a>
          <a href="services.html" data-nav="services">Servicios</a>
          <a href="#contacto" data-nav="contacto">Contacto</a>
          <a href="login.html" data-nav="login">Login</a>
          <a href="register.html" data-nav="register">Registro</a>
          <a href="dashboard.html" data-nav="dashboard" id="nav-dashboard" class="hidden">Dashboard</a>
        </nav>
        <div class="nav-user" id="nav-user-wrap">
          <span class="user-badge hidden" id="nav-user"></span>
          <a href="#" class="btn nav-logout hidden" id="nav-logout">Cerrar sesión</a>
        </div>
        <a class="btn outline nav-cta" href="services.html">Menú</a>
      </div>
    </header>

    <main class="container section">
      <h2>Historial de servicios (Admin)</h2>
      <p class="meta">Consulta el registro de servicios de un usuario: activos, en curso y completados.</p>

      <!-- Barra para buscar por correo -->
      <div class="hist-toolbar">
        <div class="form-row">
          <label for="hist-email">Correo del usuario</label>
          <input class="input" id="hist-email" type="email" placeholder="usuario@correo.com" autocomplete="email" />
        </div>
        <button class="btn brand" id="btn-cargar" type="button" style="height:42px;">Cargar historial</button>
      </div>

      <div id="hist-msg" class="meta" aria-live="polite" style="min-height:1.25rem;"></div>

      <!-- Resumen -->
      <div class="stats" id="stats" aria-hidden="true" style="display:none;">
        <div class="stat">
          <div class="k" id="st-activos">0</div>
          <div class="l">Activos</div>
        </div>
        <div class="stat">
          <div class="k" id="st-curso">0</div>
          <div class="l">En curso</div>
        </div>
        <div class="stat">
          <div class="k" id="st-historico">0</div>
          <div class="l">Completados</div>
        </div>
      </div>

      <div class="grid-cards" style="margin-top:12px">
        <article class="card">
          <div class="title">Servicios activos</div>
          <div class="content">
            <div class="table-wrap">
              <table class="table" id="tbl-activos">
                <thead>
                  <tr>
                    <th>Servicio</th><th>Fecha</th><th>Cantidad</th><th>Estado</th><th>Total</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="title">En curso</div>
          <div class="content">
            <div class="table-wrap">
              <table class="table" id="tbl-curso">
                <thead>
                  <tr>
                    <th>Servicio</th><th>Fecha</th><th>Cantidad</th><th>Estado</th><th>Total</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </article>

        <article class="card">
          <div class="title">Histórico</div>
          <div class="content">
            <div class="table-wrap">
              <table class="table" id="tbl-historico">
                <thead>
                  <tr>
                    <th>Servicio</th><th>Fecha</th><th>Cantidad</th><th>Estado</th><th>Total</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </article>
      </div>
    </main>

    <footer class="footer">
      <div class="container">©2025 NOVATech • <a href="mailto:contacto@novatech.com">contacto@novatech.com</a></div>
    </footer>

    <!-- JS general del sitio -->
    <script src="script.js"></script>

    <!-- Lógica de historial para Admin (solo lectura) -->
    <script>
      (function(){
        // Seguridad: solo admin puede estar aquí (tu script.js también lo valida con guardRoute())
        try {
          var user = (localStorage.getItem('nv-user') || '').toLowerCase();
          var ok   = localStorage.getItem('nv-auth') === 'ok';
          if (!(ok && user === 'admin@novatech.com')) {
            window.location.href = ok ? 'dashboard.html' : 'login.html';
            return;
          }
        } catch (_) {
          window.location.href = 'login.html';
          return;
        }

        var emailInput = document.getElementById('hist-email');
        var btn = document.getElementById('btn-cargar');
        var msg = document.getElementById('hist-msg');

        var activosBody = document.querySelector('#tbl-activos tbody');
        var cursoBody   = document.querySelector('#tbl-curso tbody');
        var histBody    = document.querySelector('#tbl-historico tbody');

        var stWrap = document.getElementById('stats');
        var stAct  = document.getElementById('st-activos');
        var stCur  = document.getElementById('st-curso');
        var stHis  = document.getElementById('st-historico');

        function fmtDate(iso){
          var d = new Date(iso);
          return isNaN(d) ? '' : d.toLocaleDateString();
        }
        function rowHTML(o){
          return '' +
            '<td>' + (o.servicio || o.service_name || o.name || '') + '</td>' +
            '<td>' + fmtDate(o.creado_en || o.created_at || o.date) + '</td>' +
            '<td>' + (o.cantidad || o.qty || 1) + '</td>' +
            '<td><span class="pill">' + (o.estado || o.status || '') + '</span></td>' +
            '<td>$' + Number(o.total || 0).toFixed(2) + '</td>';
        }
        function clearTables(){
          if (activosBody) activosBody.innerHTML = '';
          if (cursoBody)   cursoBody.innerHTML   = '';
          if (histBody)    histBody.innerHTML    = '';
        }
        function paint(data){
          clearTables();
          var cAct=0, cCur=0, cHis=0;
          (data || []).forEach(function(o){
            var estado = o.estado || o.status;
            if (estado === 'En curso'){ var tr=document.createElement('tr'); tr.innerHTML=rowHTML(o); cursoBody.appendChild(tr); cCur++; }
            if (estado === 'Completado'){ var tr2=document.createElement('tr'); tr2.innerHTML=rowHTML(o); histBody.appendChild(tr2); cHis++; }
            if (estado !== 'Completado' && estado !== 'Cancelado'){ var tr3=document.createElement('tr'); tr3.innerHTML=rowHTML(o); activosBody.appendChild(tr3); cAct++; }
          });
          stAct.textContent = cAct;
          stCur.textContent = cCur;
          stHis.textContent = cHis;
          stWrap.style.display = 'grid';
          stWrap.setAttribute('aria-hidden','false');
        }

        function getApiBase(){
          var meta = document.querySelector('meta[name="api-base"]');
          var metaBase = meta && meta.getAttribute('content');
          var winBase = (typeof window !== 'undefined' && window.API_BASE) ? window.API_BASE : '';
          var sameOrigin = (location.protocol !== 'file:') ? '' : '';
          var hard = 'http://localhost:3001';
          return (metaBase || winBase || sameOrigin || hard).replace(/\/$/,'');
        }

        function loadByEmail(email){
          msg.className = 'meta'; msg.textContent = '';
          if(!email){ msg.className = 'meta error'; msg.textContent = 'Ingresa un correo válido.'; return; }
          var url = getApiBase() + '/api/ordenes?usuario=' + encodeURIComponent(email.toLowerCase());
          fetch(url, { headers: { 'Accept':'application/json' } })
            .then(function(r){ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
            .then(function(json){
              paint(json || []);
              if (!json || json.length === 0){
                msg.className = 'meta'; 
                msg.textContent = 'Sin registros para ' + email + '.';
              } else {
                msg.className = 'meta ok';
                msg.textContent = 'Historial cargado para ' + email + '.';
              }
            })
            .catch(function(err){
              clearTables();
              msg.className = 'meta error';
              msg.textContent = 'No se pudo obtener el historial (' + (err && err.message ? err.message : 'Error') + ').';
            });
        }

        btn.addEventListener('click', function(){
          loadByEmail(emailInput.value.trim());
        });

        // Autocarga: si hay usuario logueado, sugerir y cargar
        var current = (localStorage.getItem('nv-user') || '').toLowerCase();
        if (current){
          emailInput.value = current;
          loadByEmail(current);
        }
      })();
    </script>
  </body>
</html>


